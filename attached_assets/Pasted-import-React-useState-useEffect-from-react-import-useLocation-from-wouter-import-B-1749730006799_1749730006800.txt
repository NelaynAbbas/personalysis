import React, { useState, useEffect } from "react";
import { useLocation } from "wouter";
import { Button } from "../components/ui/button";
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "../components/ui/card";
import { Progress } from "../components/ui/progress";
import { Skeleton } from "../components/ui/skeleton";
import { useToast } from "../hooks/use-toast";
import { apiRequest } from "../lib/queryClient";
import { Loader2, ChevronLeft, ChevronRight, CheckCircle2, AlertCircle } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

type AnonymousSurveyProps = {
  shareId: string;
};

interface SurveyQuestion {
  id: number;
  text: string;
  options: Array<{ value: string; text: string }>;
  type: string;
  category?: string;
  required?: boolean;
}

interface SurveyDetails {
  surveyId: number;
  title: string;
  description: string;
  surveyType: string;
  companyId?: number;
  companyInfo?: {
    name: string;
    logo?: string;
    website?: string;
  };
}

export default function AnonymousSurvey({ shareId }: AnonymousSurveyProps) {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  
  const [loading, setLoading] = useState(true);
  const [surveyDetails, setSurveyDetails] = useState<SurveyDetails | null>(null);
  const [questions, setQuestions] = useState<SurveyQuestion[]>([]);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [answers, setAnswers] = useState<Record<number, string>>({});
  const [sessionId, setSessionId] = useState<number | null>(null);
  const [submitting, setSubmitting] = useState(false);
  const [completed, setCompleted] = useState(false);
  const [showThankYou, setShowThankYou] = useState(false);
  const [animationDirection, setAnimationDirection] = useState(0);
  const [loadingError, setLoadingError] = useState<string | null>(null);
  
  // Calculate progress percentage
  const progressPercentage = questions.length > 0
    ? ((currentQuestionIndex + 1) / questions.length) * 100
    : 0;
  
  // Demographic questions will be shown at the end
  const [demographicInfo, setDemographicInfo] = useState({
    age: 0,
    gender: "",
    location: "",
    education: "",
    income: "",
    occupation: "",
    interests: [] as string[]
  });

  // Fetch survey details and questions
  useEffect(() => {
    async function fetchSurveyDetails() {
      try {
        setLoading(true);
        const surveyDetailsResponse = await apiRequest(`/api/survey/details/${shareId}`);
        
        if (!surveyDetailsResponse.ok) {
          throw new Error("Failed to load survey details");
        }
        
        const surveyDetailsData = await surveyDetailsResponse.json();
        setSurveyDetails(surveyDetailsData);
        
        // Also load questions for this survey type
        const questionsResponse = await apiRequest(`/api/survey/questions?type=${surveyDetailsData.surveyType}`);
        
        if (!questionsResponse.ok) {
          throw new Error("Failed to load survey questions");
        }
        
        const questionsData = await questionsResponse.json();
        setQuestions(questionsData);
        
        // Start a new survey session
        const sessionResponse = await apiRequest(
          "/api/survey/start",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              surveyId: surveyDetailsData.surveyId,
              companyId: surveyDetailsData.companyId || 1,
              surveyType: surveyDetailsData.surveyType
            })
          }
        );
        
        if (!sessionResponse.ok) {
          throw new Error("Failed to start survey session");
        }
        
        const sessionData = await sessionResponse.json();
        setSessionId(sessionData.sessionId);
        
        setLoading(false);
      } catch (error) {
        console.error("Error loading survey:", error);
        setLoadingError("This survey is not available or has expired. Please contact the survey administrator.");
        setLoading(false);
      }
    }
    
    fetchSurveyDetails();
  }, [shareId]);
  
  const handleAnswer = async (questionId: number, answer: string) => {
    // Save the answer
    const newAnswers = { ...answers, [questionId]: answer };
    setAnswers(newAnswers);
    
    // Record the answer via API
    if (sessionId) {
      try {
        const response = await apiRequest("/api/survey/answer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionId,
            questionId,
            answer
          })
        });
        
        if (!response.ok) {
          toast({
            title: "Error saving answer",
            description: "Your answer couldn't be saved. Please try again.",
            variant: "destructive"
          });
        }
      } catch (error) {
        console.error("Error saving answer:", error);
      }
    }
    
    // Move to the next question automatically after a short delay
    setTimeout(() => {
      if (currentQuestionIndex < questions.length - 1) {
        setAnimationDirection(1); // Set direction to forward
        setCurrentQuestionIndex(currentQuestionIndex + 1);
      }
    }, 400); // Slight delay for better UX
  };
  
  const handlePrevious = () => {
    if (currentQuestionIndex > 0) {
      setAnimationDirection(-1); // Set direction to backward
      setCurrentQuestionIndex(currentQuestionIndex - 1);
    }
  };
  
  const handleNext = () => {
    setAnimationDirection(1); // Set direction to forward
    if (currentQuestionIndex < questions.length - 1) {
      setCurrentQuestionIndex(currentQuestionIndex + 1);
    } else {
      setCompleted(true);
    }
  };
  
  const handleDemographicChange = (field: string, value: string | number | string[]) => {
    setDemographicInfo({
      ...demographicInfo,
      [field]: value
    });
  };
  
  const handleSubmit = async () => {
    if (!sessionId) return;
    
    setSubmitting(true);
    
    try {
      const response = await apiRequest("/api/survey/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId,
          demographicInfo
        })
      });
      